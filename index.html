<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GuV Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
    body { -webkit-app-region: drag; }
    button, input, select, a, .no-drag { -webkit-app-region: no-drag; }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    .fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div id="app"></div>

  <script>
    // ===== ELECTRON / WEB FALLBACK =====
    let ipcRenderer;
    const isElectron = (typeof process !== 'undefined') && process.versions && process.versions.electron;
    
    if (isElectron) {
      ipcRenderer = require('electron').ipcRenderer;
    } else {
      // Web-Version (GitHub Pages): localStorage-basierter Fallback
      ipcRenderer = {
        invoke: async (channel, data) => {
          switch (channel) {
            case 'load-data':
              try {
                const stored = localStorage.getItem('guv-manager-data');
                return stored ? JSON.parse(stored) : null;
              } catch { return null; }
            
            case 'save-data':
              try {
                localStorage.setItem('guv-manager-data', JSON.stringify(data));
                return true;
              } catch { return false; }
            
            case 'select-pdf': {
              return new Promise((resolve) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.pdf';
                input.onchange = async (e) => {
                  const file = e.target.files[0];
                  if (!file) return resolve(null);
                  const reader = new FileReader();
                  reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve({ base64, fileName: file.name });
                  };
                  reader.onerror = () => resolve(null);
                  reader.readAsDataURL(file);
                };
                input.click();
              });
            }
            
            case 'select-csv': {
              return new Promise((resolve) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv,.tsv,.txt';
                input.onchange = async (e) => {
                  const file = e.target.files[0];
                  if (!file) return resolve(null);
                  const reader = new FileReader();
                  reader.onload = () => resolve(reader.result);
                  reader.onerror = () => resolve(null);
                  reader.readAsText(file);
                };
                input.click();
              });
            }
            
            case 'save-export': {
              const blob = new Blob([data.content], { type: 'text/plain;charset=utf-8' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = data.filename || 'export.txt';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
              return true;
            }
            
            case 'import-backup': {
              return new Promise((resolve) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = async (e) => {
                  const file = e.target.files[0];
                  if (!file) return resolve(null);
                  const reader = new FileReader();
                  reader.onload = () => resolve(reader.result);
                  reader.onerror = () => resolve(null);
                  reader.readAsText(file);
                };
                input.click();
              });
            }
            
            default:
              return null;
          }
        }
      };
    }
    
    // ===== KONSTANTEN =====
    const MONTHS = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
    const VAT_RATE = 0.19;
    
    const CATEGORIES = {
      versand: { name: 'Versand & Logistik', color: 'amber', icon: 'üì¶' },
      zahlungen: { name: 'Zahlungsgeb√ºhren', color: 'cyan', icon: 'üí≥' },
      tools: { name: 'Tools & Software', color: 'purple', icon: 'üíª' },
      marketing: { name: 'Marketing', color: 'pink', icon: 'üì£' },
      sonstige: { name: 'Sonstige Kosten', color: 'slate', icon: 'üìã' }
    };
    
    // Automatische Kategorie-Erkennung basierend auf Lieferantenname
    const SUPPLIER_CATEGORIES = {
      // Versand & Logistik
      'dhl': 'versand', 'dpd': 'versand', 'ups': 'versand', 'hermes': 'versand', 'gls': 'versand',
      'deutsche post': 'versand', 'fedex': 'versand', 'amazon logistics': 'versand',
      'sendcloud': 'versand', 'shipcloud': 'versand', 'packlink': 'versand',
      
      // Tools & Software
      'shopify': 'tools', 'woocommerce': 'tools', 'magento': 'tools',
      'klaviyo': 'tools', 'mailchimp': 'tools', 'sendinblue': 'tools', 'brevo': 'tools',
      'sevdesk': 'tools', 'lexoffice': 'tools', 'billomat': 'tools', 'fastbill': 'tools',
      'google workspace': 'tools', 'microsoft 365': 'tools', 'notion': 'tools', 'slack': 'tools',
      'adobe': 'tools', 'canva': 'tools', 'figma': 'tools',
      'zendesk': 'tools', 'freshdesk': 'tools', 'intercom': 'tools',
      
      // Zahlungsanbieter
      'stripe': 'zahlungen', 'paypal': 'zahlungen', 'klarna': 'zahlungen', 'mollie': 'zahlungen',
      'shopify payments': 'zahlungen', 'adyen': 'zahlungen', 'payone': 'zahlungen',
      'amazon pay': 'zahlungen', 'apple pay': 'zahlungen', 'google pay': 'zahlungen',
      
      // Marketing
      'facebook': 'marketing', 'meta': 'marketing', 'instagram': 'marketing',
      'google ads': 'marketing', 'google adwords': 'marketing',
      'tiktok': 'marketing', 'pinterest': 'marketing', 'linkedin': 'marketing',
      'influencer': 'marketing', 'agentur': 'marketing',
      
      // Sonstige
      'telekom': 'sonstige', 'vodafone': 'sonstige', 'o2': 'sonstige',
      'versicherung': 'sonstige', 'allianz': 'sonstige', 'axa': 'sonstige',
      'steuerberater': 'sonstige', 'rechtsanwalt': 'sonstige',
      'miete': 'sonstige', 'strom': 'sonstige', 'gas': 'sonstige'
    };
    
    function detectCategory(supplierName) {
      const lower = supplierName.toLowerCase();
      for (const [keyword, category] of Object.entries(SUPPLIER_CATEGORIES)) {
        if (lower.includes(keyword)) return category;
      }
      return 'sonstige';
    }
    
    // ===== STATE =====
    let state = {
      years: {},
      selectedYear: 2026,
      selectedMonth: 'Januar',
      activeTab: 'eingabe',
      apiKey: '',
      showApiKeyModal: false,
      showPdfModal: false,
      showSettingsModal: false,
      showPaypalHelpModal: false,
      showShopifyPaymentsHelpModal: false,
      showExportModal: false,
      pdfProcessing: false,
      pdfResult: null,
      saveStatus: 'saved',
      productsCollapsed: true, // Produkte standardm√§√üig eingeklappt
      expandedProductId: null, // F√ºr Retouren-Eingabe
      // R√ºcklage-Prozentsatz
      ruecklageShop: 40,
      // Standard-EK-Werte f√ºr Varianten (anpassbar in Einstellungen)
      ekPresets: {
        '250 x 100': 66.27,
        '250 x 130': 86.15,
        '300 x 130': 103.38,
        '20 x 15 muster': 2.51,
        'muster': 2.51
      }
    };
    
    // Kostenkategorien f√ºr Shop
    const CATEGORIES_SHOP = {
      versand: { name: 'Versand & Logistik', color: 'amber', icon: 'üì¶' },
      zahlungen: { name: 'Zahlungsgeb√ºhren', color: 'cyan', icon: 'üí≥' },
      tools: { name: 'Tools & Software', color: 'purple', icon: 'üíª' },
      marketing: { name: 'Marketing', color: 'pink', icon: 'üì£' },
      sonstige: { name: 'Sonstige Kosten', color: 'slate', icon: 'üìã' }
    };
    
    
    // Standard-Monatsdaten Shop
    function createDefaultMonthData() {
      return {
        products: [
          { id: Date.now(), name: 'Produkt 1', quantity: 0, vkBrutto: 0, ek: 0, retourenAnzahl: 0, retourenBrutto: 0 },
          { id: Date.now() + 1, name: 'Produkt 2', quantity: 0, vkBrutto: 0, ek: 0, retourenAnzahl: 0, retourenBrutto: 0 },
          { id: Date.now() + 2, name: 'Produkt 3', quantity: 0, vkBrutto: 0, ek: 0, retourenAnzahl: 0, retourenBrutto: 0 },
          { id: Date.now() + 3, name: 'Produkt 4', quantity: 0, vkBrutto: 0, ek: 0, retourenAnzahl: 0, retourenBrutto: 0 }
        ],
        versandEinnahmen: 0,
        // Feste Zahlungsgeb√ºhren
        zahlungsgebuehren: {
          paypal: 0,
          shopifyPayments: 0,
          klarna: 0
        },
        costs: []
      };
    }
    
    
    function createYearData() {
      const data = {};
      MONTHS.forEach(m => { data[m] = createDefaultMonthData(); });
      return data;
    }
    
    
    // ===== BERECHNUNGEN =====
    const formatCurrency = (val) => new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(val || 0);
    const formatPercent = (val) => new Intl.NumberFormat('de-DE', { style: 'percent', minimumFractionDigits: 1 }).format(val || 0);
    
    // Produkt-Berechnungen MIT Retouren
    // Umsatz brutto = Verkaufs-Umsatz - Retouren-Umsatz
    function calcProductUmsatzBrutto(p) { 
      return (p.vkBrutto || 0) - (p.retourenBrutto || 0); 
    }
    function calcProductUmsatzNetto(p) { 
      return calcProductUmsatzBrutto(p) / (1 + VAT_RATE); 
    }
    // Wareneinsatz = (Verkauft - Retouren) √ó EK pro St√ºck
    function calcProductWareneinsatz(p) { 
      const nettoAnzahl = (p.quantity || 0) - (p.retourenAnzahl || 0);
      return Math.max(0, nettoAnzahl) * (p.ek || 0); 
    }
    // Netto-Anzahl (f√ºr Anzeige)
    function calcProductNettoAnzahl(p) {
      return (p.quantity || 0) - (p.retourenAnzahl || 0);
    }
    
    function calcMonthData(monthData) {
      const products = monthData.products || [];
      const costs = monthData.costs || [];
      const zahlungsgebuehren = monthData.zahlungsgebuehren || { paypal: 0, shopifyPayments: 0, klarna: 0 };
      
      // UMSATZ (alles Netto f√ºr GuV) - bereits mit Retouren verrechnet
      const umsatzBrutto = products.reduce((s, p) => s + calcProductUmsatzBrutto(p), 0);
      const umsatzNetto = products.reduce((s, p) => s + calcProductUmsatzNetto(p), 0);
      
      // Retouren-Summen (f√ºr Anzeige)
      const retourenBruttoGesamt = products.reduce((s, p) => s + (p.retourenBrutto || 0), 0);
      const retourenAnzahlGesamt = products.reduce((s, p) => s + (p.retourenAnzahl || 0), 0);
      
      // WARENEINSATZ (ist bereits Netto - EK ist immer netto) - mit Retouren verrechnet
      const wareneinsatz = products.reduce((s, p) => s + calcProductWareneinsatz(p), 0);
      
      // ROHERTRAG
      const rohertrag = umsatzNetto - wareneinsatz;
      
      // VERSANDEINNAHMEN
      const versandEinnahmenBrutto = monthData.versandEinnahmen || 0;
      const versandEinnahmenNetto = versandEinnahmenBrutto / (1 + VAT_RATE);
      
      // ZAHLUNGSGEB√úHREN (netto, da B2B-Leistungen meist ohne MwSt. oder Reverse Charge)
      const zahlungsgebuehrenGesamt = (zahlungsgebuehren.paypal || 0) + (zahlungsgebuehren.shopifyPayments || 0) + (zahlungsgebuehren.klarna || 0);
      
      // KOSTEN nach Kategorie (Brutto eingegeben ‚Üí Netto f√ºr GuV)
      const kostenByKategorieBrutto = { versand: 0, zahlungen: zahlungsgebuehrenGesamt, tools: 0, marketing: 0, sonstige: 0 };
      const kostenByKategorieNetto = { versand: 0, zahlungen: zahlungsgebuehrenGesamt, tools: 0, marketing: 0, sonstige: 0 };
      
      costs.forEach(c => {
        const betragBrutto = c.betrag || 0;
        const kat = c.kategorie || 'sonstige';
        // Zahlungsgeb√ºhren aus costs ignorieren (werden separat gehandhabt)
        if (kat === 'zahlungen') return;
        
        kostenByKategorieBrutto[kat] = (kostenByKategorieBrutto[kat] || 0) + betragBrutto;
        
        // Personal hat keine MwSt., alle anderen schon
        if (c.name?.toLowerCase().includes('personal') || c.name?.toLowerCase().includes('gehalt') || c.name?.toLowerCase().includes('lohn')) {
          kostenByKategorieNetto[kat] = (kostenByKategorieNetto[kat] || 0) + betragBrutto;
        } else {
          kostenByKategorieNetto[kat] = (kostenByKategorieNetto[kat] || 0) + (betragBrutto / (1 + VAT_RATE));
        }
      });
      
      const kostenGesamtBrutto = Object.values(kostenByKategorieBrutto).reduce((a, b) => a + b, 0);
      const kostenGesamtNetto = Object.values(kostenByKategorieNetto).reduce((a, b) => a + b, 0);
      
      // BETRIEBSERGEBNIS (alles Netto)
      const betriebsergebnis = rohertrag + versandEinnahmenNetto - kostenGesamtNetto;
      
      // MwSt.-Berechnung (nur zur Info, nicht Teil der GuV)
      const umsatzsteuer = umsatzBrutto - umsatzNetto + versandEinnahmenBrutto - versandEinnahmenNetto;
      const vorsteuer = kostenGesamtBrutto - kostenGesamtNetto;
      const mwstZahllast = umsatzsteuer - vorsteuer;
      
      // NETTOGEWINN = Betriebsergebnis (vor Einkommensteuer)
      const nettogewinn = betriebsergebnis;
      const gewinnmarge = umsatzNetto > 0 ? nettogewinn / umsatzNetto : 0;
      
      return {
        umsatzBrutto, umsatzNetto, wareneinsatz, rohertrag,
        retourenBruttoGesamt, retourenAnzahlGesamt,
        versandEinnahmenBrutto, versandEinnahmenNetto,
        zahlungsgebuehren, zahlungsgebuehrenGesamt,
        kostenByKategorieBrutto, kostenByKategorieNetto,
        kostenGesamtBrutto, kostenGesamtNetto,
        betriebsergebnis,
        umsatzsteuer, vorsteuer, mwstZahllast,
        nettogewinn, gewinnmarge
      };
    }
    
    
    // ===== DATEN LADEN/SPEICHERN =====
    async function loadData() {
      const data = await ipcRenderer.invoke('load-data');
      if (data) {
        // Shop-Daten (Abw√§rtskompatibilit√§t: alte 'years' ‚Üí neue 'yearsShop')
        state.years = data.yearsShop || data.years || { 2026: createYearData() };
        state.selectedYear = data.selectedYear || 2026;
        state.apiKey = data.apiKey || '';
        state.ekPresets = data.ekPresets || state.ekPresets;
        state.ruecklageShop = data.ruecklageShop ?? 40;
      } else {
        state.years = { 2026: createYearData() };
      }
      render();
    }
    
    async function saveData() {
      state.saveStatus = 'saving';
      render();
      const success = await ipcRenderer.invoke('save-data', {
        yearsShop: state.years,
        selectedYear: state.selectedYear,
        apiKey: state.apiKey,
        ekPresets: state.ekPresets,
        ruecklageShop: state.ruecklageShop
      });
      state.saveStatus = success ? 'saved' : 'error';
      render();
    }
    
    // ===== PDF ANALYSE =====
    async function fetchExchangeRate(fromCurrency) {
      // Kostenlose API f√ºr Wechselkurse
      try {
        const response = await fetch(`https://api.frankfurter.app/latest?from=${fromCurrency}&to=EUR`);
        const data = await response.json();
        return data.rates?.EUR || null;
      } catch (err) {
        console.error('Wechselkurs-Fehler:', err);
        return null;
      }
    }
    
    async function handlePdfUpload() {
      if (!state.apiKey) {
        state.showApiKeyModal = true;
        render();
        return;
      }
      
      const result = await ipcRenderer.invoke('select-pdf');
      if (!result) return;
      
      state.pdfProcessing = true;
      state.pdfResult = null;
      state.showPdfModal = true;
      render();
      
      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': state.apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1000,
            messages: [{
              role: 'user',
              content: [
                {
                  type: 'document',
                  source: { type: 'base64', media_type: 'application/pdf', data: result.base64 }
                },
                {
                  type: 'text',
                  text: `Analysiere diese Rechnung und extrahiere die folgenden Informationen im JSON-Format:
{
  "lieferant": "Exakter Name des Lieferanten/Unternehmens von der Rechnung",
  "datum": "Rechnungsdatum im Format YYYY-MM-DD",
  "brutto": Bruttobetrag als Zahl (nur die Zahl, kein W√§hrungssymbol),
  "netto": Nettobetrag als Zahl,
  "mwst": MwSt-Betrag als Zahl (0 falls keine MwSt ausgewiesen),
  "waehrung": "W√§hrungscode (EUR, USD, GBP, CHF etc.)",
  "beschreibung": "Kurze Beschreibung der Leistung/Produkte"
}
WICHTIG: Gib NUR das JSON zur√ºck, keine Erkl√§rungen. Der "lieferant" sollte der genaue Firmenname sein. Die "waehrung" sollte der ISO-Code sein (z.B. "EUR", "USD", "GBP").`
                }
              ]
            }]
          })
        });
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error.message || 'API Fehler');
        }
        
        const text = data.content?.map(c => c.text || '').join('') || '';
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        
        if (jsonMatch) {
          const parsed = JSON.parse(jsonMatch[0]);
          parsed.kategorie = detectCategory(parsed.lieferant);
          parsed.fileName = result.fileName;
          parsed.waehrung = parsed.waehrung || 'EUR';
          
          // Wenn Fremdw√§hrung, Wechselkurs abrufen
          if (parsed.waehrung !== 'EUR') {
            const rate = await fetchExchangeRate(parsed.waehrung);
            if (rate) {
              parsed.exchangeRate = rate;
              parsed.bruttoOriginal = parsed.brutto;
              parsed.brutto = Math.round(parsed.brutto * rate * 100) / 100;
              parsed.nettoOriginal = parsed.netto;
              parsed.netto = parsed.netto ? Math.round(parsed.netto * rate * 100) / 100 : null;
              parsed.mwstOriginal = parsed.mwst;
              parsed.mwst = parsed.mwst ? Math.round(parsed.mwst * rate * 100) / 100 : 0;
            }
          }
          
          state.pdfResult = parsed;
        } else {
          throw new Error('Keine JSON-Daten in der Antwort gefunden');
        }
      } catch (err) {
        state.pdfResult = { error: err.message };
      }
      
      state.pdfProcessing = false;
      render();
    }
    
    function applyPdfResult() {
      if (!state.pdfResult || state.pdfResult.error) return;
      
      const newCost = {
        id: Date.now(),
        name: state.pdfResult.lieferant,
        kategorie: state.pdfResult.kategorie,
        betrag: state.pdfResult.brutto || 0,
        datum: state.pdfResult.datum || new Date().toISOString().split('T')[0],
        mwst: state.pdfResult.mwst || 0,
        notiz: state.pdfResult.beschreibung || ''
      };
      
      // In die Shop-Datenstruktur einf√ºgen
      const monthData = state.years[state.selectedYear]?.[state.selectedMonth] || createDefaultMonthData();
      monthData.costs = [...(monthData.costs || []), newCost];
      state.years[state.selectedYear][state.selectedMonth] = monthData;
      
      state.showPdfModal = false;
      state.pdfResult = null;
      saveData();
    }
    
    // Kategorie im PDF-Result √§ndern
    function changePdfKategorie(newKategorie) {
      if (state.pdfResult) {
        state.pdfResult.kategorie = newKategorie;
        render();
      }
    }
    
    // ===== CSV IMPORT (Shopify) =====
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(';').map(h => h.trim().replace(/^"|"$/g, ''));
      
      return lines.slice(1).map(line => {
        const values = [];
        let current = '';
        let inQuotes = false;
        
        for (let char of line) {
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ';' && !inQuotes) {
            values.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current.trim());
        
        const row = {};
        headers.forEach((h, i) => {
          row[h] = values[i] || '';
        });
        return row;
      });
    }
    
    async function handleCsvImport() {
      const csvContent = await ipcRenderer.invoke('select-csv');
      if (!csvContent) return;
      
      try {
        const rows = parseCSV(csvContent);
        
        // Jahr sicherstellen
        if (!state.years[state.selectedYear]) {
          state.years[state.selectedYear] = createYearData();
        }
        const monthData = state.years[state.selectedYear][state.selectedMonth] || createDefaultMonthData();
        
        rows.forEach(row => {
          // Spalten: Variantentitel, Produkttitel, Gesamtumsatz, Netto verkaufte Artikel, Kosten der verkauften Waren
          let variante = row['Variantentitel'] || row['Variante'] || '';
          let produkt = row['Produkttitel'] || row['Produkt'] || row['Titel'] || '';
          
          // Default Title durch Produkttitel ersetzen
          if (variante === 'Default Title' && produkt) {
            variante = produkt;
          }
          
          const revenueStr = row['Gesamtumsatz'] || row['Umsatz'] || row['Bruttoumsatz'] || '0';
          const revenue = parseFloat(revenueStr.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
          
          const unitsStr = row['Netto verkaufte Artikel'] || row['Menge'] || row['Anzahl'] || '0';
          const units = parseInt(unitsStr) || 0;
          
          const wareneinsatzStr = row['Kosten der verkauften Waren'] || row['Wareneinsatz'] || '0';
          const wareneinsatz = Math.abs(parseFloat(wareneinsatzStr.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0);
          
          if ((variante || produkt) && (revenue > 0 || units > 0)) {
            // Produktname zusammensetzen
            let name = '';
            if (produkt && variante && produkt !== variante) {
              name = `${produkt} - ${variante}`;
            } else if (variante) {
              name = variante;
            } else {
              name = produkt;
            }
            
            // EK pro St√ºck berechnen aus Wareneinsatz
            const ekProStueck = units > 0 ? wareneinsatz / units : 0;
            
            monthData.products.push({
              id: Date.now() + Math.random(),
              name: name,
              quantity: units,
              vkBrutto: revenue,
              ek: Math.round(ekProStueck * 100) / 100,
              retourenAnzahl: 0,
              retourenBrutto: 0
            });
          }
        });
        
        state.years[state.selectedYear][state.selectedMonth] = monthData;
        saveData();
        alert(`${rows.length} Produkte importiert!`);
      } catch (err) {
        alert('Fehler beim Import: ' + err.message);
      }
    }
    
    // ===== CSV HILFSFUNKTIONEN =====
    // CSV-Zeile parsen (ber√ºcksichtigt Anf√ºhrungszeichen, flexibler Delimiter)
    function parseCSVLine(line, delimiter) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === delimiter && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);
      return result.map(s => s.replace(/^"|"$/g, '').trim());
    }
    
    // Deutsche Zahlen parsen (z.B. "1.234,56 ‚Ç¨" ‚Üí 1234.56)
    function parseGermanNumber(str) {
      if (!str) return 0;
      let cleaned = str.replace(/[‚Ç¨$\s]/g, '').trim();
      if (!cleaned) return 0;
      const hasComma = cleaned.includes(',');
      const hasDot = cleaned.includes('.');
      if (hasComma && hasDot) {
        if (cleaned.lastIndexOf(',') > cleaned.lastIndexOf('.')) {
          cleaned = cleaned.replace(/\./g, '').replace(',', '.');
        } else {
          cleaned = cleaned.replace(/,/g, '');
        }
      } else if (hasComma) {
        cleaned = cleaned.replace(',', '.');
      }
      return parseFloat(cleaned) || 0;
    }
    
    // ===== PAYPAL CSV IMPORT =====
    async function handlePaypalCsvImport() {
      const csvContent = await ipcRenderer.invoke('select-csv');
      if (!csvContent) return;
      
      try {
        const lines = csvContent.split('\n').filter(l => l.trim());
        const delimiter = lines[0].includes(';') ? ';' : ',';
        
        // Header finden
        const headers = parseCSVLine(lines[0], delimiter).map(h => h.toLowerCase().trim());
        
        // Fee-Spalte finden
        const feeIdx = headers.findIndex(h => h === 'fee' || h === 'geb√ºhren' || h === 'geb√ºhr');
        
        if (feeIdx === -1) {
          alert('PayPal CSV-Format nicht erkannt. Ben√∂tigte Spalte: "Fee" oder "Geb√ºhren"');
          return;
        }
        
        // Geb√ºhren summieren
        let totalFees = 0;
        for (let i = 1; i < lines.length; i++) {
          const cols = parseCSVLine(lines[i], delimiter);
          if (cols.length <= feeIdx) continue;
          
          const feeRaw = cols[feeIdx]?.trim() || '0';
          const fee = Math.abs(parseGermanNumber(feeRaw)); // Absolute Werte (Fees sind oft negativ)
          totalFees += fee;
        }
        
        // In Monatsdaten eintragen
        const monthData = state.years[state.selectedYear]?.[state.selectedMonth] || createDefaultMonthData();
        if (!monthData.zahlungsgebuehren) {
          monthData.zahlungsgebuehren = { paypal: 0, shopifyPayments: 0, klarna: 0 };
        }
        monthData.zahlungsgebuehren.paypal = Math.round(totalFees * 100) / 100;
        state.years[state.selectedYear][state.selectedMonth] = monthData;
        
        saveData();
        alert(`PayPal Geb√ºhren importiert: ${formatCurrency(totalFees)}`);
        
      } catch (err) {
        alert('Fehler beim Parsen der PayPal CSV: ' + err.message);
      }
    }
    
    // ===== SHOPIFY PAYMENTS PDF IMPORT =====
    async function handleShopifyPaymentsPdfImport() {
      if (!state.apiKey) {
        state.showApiKeyModal = true;
        render();
        return;
      }
      
      const result = await ipcRenderer.invoke('select-pdf');
      if (!result) return;
      
      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': state.apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 500,
            messages: [{
              role: 'user',
              content: [
                {
                  type: 'document',
                  source: { type: 'base64', media_type: 'application/pdf', data: result.base64 }
                },
                {
                  type: 'text',
                  text: `Extrahiere aus dieser Shopify Payments Rechnung die "Transaction Fees" (Transaktionsgeb√ºhren). 
Gib NUR eine Zahl zur√ºck im Format: {"transactionFees": 17.06}
Keine weiteren Erkl√§rungen.`
                }
              ]
            }]
          })
        });
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error.message || 'API Fehler');
        }
        
        const text = data.content?.map(c => c.text || '').join('') || '';
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        
        if (jsonMatch) {
          const parsed = JSON.parse(jsonMatch[0]);
          const fees = parsed.transactionFees || 0;
          
          // In Monatsdaten eintragen
          const monthData = state.years[state.selectedYear]?.[state.selectedMonth] || createDefaultMonthData();
          if (!monthData.zahlungsgebuehren) {
            monthData.zahlungsgebuehren = { paypal: 0, shopifyPayments: 0, klarna: 0 };
          }
          monthData.zahlungsgebuehren.shopifyPayments = fees;
          state.years[state.selectedYear][state.selectedMonth] = monthData;
          
          saveData();
          alert(`Shopify Payments Geb√ºhren importiert: ${formatCurrency(fees)}`);
        } else {
          throw new Error('Keine Geb√ºhren in der PDF gefunden');
        }
        
      } catch (err) {
        alert('Fehler beim Verarbeiten der Shopify Payments PDF: ' + err.message);
      }
    }
    
    // Zahlungsgeb√ºhr manuell aktualisieren
    function updateZahlungsgebuehr(anbieter, value) {
      const monthData = state.years[state.selectedYear]?.[state.selectedMonth] || createDefaultMonthData();
      if (!monthData.zahlungsgebuehren) {
        monthData.zahlungsgebuehren = { paypal: 0, shopifyPayments: 0, klarna: 0 };
      }
      monthData.zahlungsgebuehren[anbieter] = parseFloat(value) || 0;
      state.years[state.selectedYear][state.selectedMonth] = monthData;
      saveData();
    }
    
    // EK-Preset aktualisieren
    function updateEkPreset(key, value) {
      state.ekPresets[key] = parseFloat(value) || 0;
      saveData();
    }
    
    // Neues EK-Preset hinzuf√ºgen
    function addEkPreset() {
      const name = prompt('Variantenname eingeben (z.B. "300 x 150"):');
      if (name && name.trim()) {
        const ek = prompt('EK (netto) eingeben:');
        if (ek) {
          state.ekPresets[name.trim()] = parseFloat(ek.replace(',', '.')) || 0;
          saveData();
        }
      }
    }
    
    // EK-Preset l√∂schen
    function removeEkPreset(key) {
      if (confirm(`EK-Preset "${key}" wirklich l√∂schen?`)) {
        delete state.ekPresets[key];
        saveData();
      }
    }
    
    // ===== AKTIONEN =====
    function addYear() {
      const maxYear = Math.max(...Object.keys(state.years).map(Number));
      const newYear = maxYear + 1;
      state.years[newYear] = createYearData();
      state.selectedYear = newYear;
      saveData();
    }
    
    
    // ===== SHOP FUNKTIONEN =====
    function addProduct() {
      const monthData = state.years[state.selectedYear]?.[state.selectedMonth] || createDefaultMonthData();
      monthData.products.push({ 
        id: Date.now(), 
        name: `Produkt ${monthData.products.length + 1}`, 
        quantity: 0, 
        vkBrutto: 0, 
        ek: 0,
        retourenAnzahl: 0,
        retourenBrutto: 0
      });
      state.years[state.selectedYear][state.selectedMonth] = monthData;
      saveData();
    }
    
    function removeProduct(id) {
      const monthData = state.years[state.selectedYear]?.[state.selectedMonth];
      if (!monthData || monthData.products.length <= 1) return;
      monthData.products = monthData.products.filter(p => p.id !== id);
      saveData();
    }
    
    function updateProduct(id, field, value) {
      const monthData = state.years[state.selectedYear]?.[state.selectedMonth];
      if (!monthData) return;
      const product = monthData.products.find(p => p.id === id);
      if (product) {
        product[field] = field === 'name' ? value : parseFloat(value) || 0;
        saveData();
      }
    }
    
    function toggleProductExpand(id) {
      state.expandedProductId = state.expandedProductId === id ? null : id;
      render();
    }
    
    function updateVersandEinnahmen(value) {
      const monthData = state.years[state.selectedYear]?.[state.selectedMonth] || createDefaultMonthData();
      monthData.versandEinnahmen = parseFloat(value) || 0;
      state.years[state.selectedYear][state.selectedMonth] = monthData;
      saveData();
    }
    
    function addManualCost(kategorie) {
      const monthData = state.years[state.selectedYear]?.[state.selectedMonth] || createDefaultMonthData();
      monthData.costs = [...(monthData.costs || []), {
        id: Date.now(),
        name: 'Neue Position',
        kategorie: kategorie,
        betrag: 0,
        datum: new Date().toISOString().split('T')[0],
        mwst: 0,
        notiz: ''
      }];
      state.years[state.selectedYear][state.selectedMonth] = monthData;
      saveData();
    }
    
    function updateCost(id, field, value) {
      const monthData = state.years[state.selectedYear]?.[state.selectedMonth];
      if (!monthData) return;
      const cost = monthData.costs.find(c => c.id === id);
      if (cost) {
        cost[field] = (field === 'name' || field === 'kategorie' || field === 'notiz' || field === 'datum') ? value : parseFloat(value) || 0;
        saveData();
      }
    }
    
    function removeCost(id) {
      const monthData = state.years[state.selectedYear]?.[state.selectedMonth];
      if (!monthData) return;
      monthData.costs = monthData.costs.filter(c => c.id !== id);
      saveData();
    }
    
    
    
    // ===== RENDER =====
    function render() {
      const monthData = state.years[state.selectedYear]?.[state.selectedMonth] || createDefaultMonthData();
      const calc = calcMonthData(monthData);
      const yearSummary = MONTHS.map(m => {
        const data = state.years[state.selectedYear]?.[m] || createDefaultMonthData();
        return { month: m, ...calcMonthData(data) };
      });
      const yearTotals = yearSummary.reduce((acc, m) => ({
        umsatzBrutto: acc.umsatzBrutto + m.umsatzBrutto,
        umsatzNetto: acc.umsatzNetto + m.umsatzNetto,
        kostenGesamtNetto: acc.kostenGesamtNetto + m.kostenGesamtNetto,
        betriebsergebnis: acc.betriebsergebnis + m.betriebsergebnis,
      }), { umsatzBrutto: 0, umsatzNetto: 0, kostenGesamtNetto: 0, betriebsergebnis: 0 });
      const costsByCategory = { versand: [], zahlungen: [], tools: [], marketing: [], sonstige: [] };
      (monthData.costs || []).forEach(c => {
        if (costsByCategory[c.kategorie]) {
          costsByCategory[c.kategorie].push(c);
        } else {
          costsByCategory.sonstige.push(c);
        }
      });
      
      document.getElementById('app').innerHTML = `
        <!-- Header -->
        <header class="bg-slate-900/80 border-b border-slate-800 px-6 py-4 sticky top-0 z-50 backdrop-blur-sm">
          <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4 no-drag">
              <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-xl">
                üõí
              </div>
              <div>
                <h1 class="text-xl font-semibold tracking-tight">GuV Manager</h1>
                <p class="text-xs text-slate-500">Online Shop</p>
              </div>
            </div>
            
            <div class="flex items-center gap-4 no-drag">
              <!-- Jahr Auswahl -->
              <div class="flex items-center gap-2 bg-slate-800 rounded-lg px-3 py-2">
                <span class="text-slate-400">üìÖ</span>
                <select onchange="state.selectedYear = Number(this.value); render();" class="bg-transparent text-sm font-medium focus:outline-none cursor-pointer">
                  ${Object.keys(state.years).sort().map(y => `<option value="${y}" ${y == state.selectedYear ? 'selected' : ''} class="bg-slate-800">${y}</option>`).join('')}
                </select>
                <button onclick="addYear()" class="ml-2 p-1 hover:bg-slate-700 rounded transition-colors" title="Neues Jahr">
                  <span class="text-lg">+</span>
                </button>
              </div>
              
              <!-- Save Status -->
              <div class="flex items-center gap-2 text-xs">
                ${state.saveStatus === 'saved' ? '<span class="text-emerald-500">‚úì</span>' : state.saveStatus === 'saving' ? '<span class="text-amber-500 animate-pulse">‚óè</span>' : '<span class="text-red-500">!</span>'}
                <span class="text-slate-500">${state.saveStatus === 'saved' ? 'Gespeichert' : state.saveStatus === 'saving' ? 'Speichert...' : 'Fehler'}</span>
              </div>
              
              <!-- Settings -->
              <button onclick="state.showSettingsModal = true; render();" class="p-2 hover:bg-slate-800 rounded-lg transition-colors" title="Einstellungen">
                ‚öôÔ∏è
              </button>
            </div>
          </div>
        </header>
        
        <div class="max-w-7xl mx-auto px-6 py-6 no-drag">
          <!-- Monats-Navigation -->
          <div class="flex gap-1 mb-6 overflow-x-auto pb-2">
            ${MONTHS.map(m => {
              const mCalc = calcMonthData(state.years[state.selectedYear]?.[m] || createDefaultMonthData());
              const hasData = mCalc.umsatzBrutto > 0 || mCalc.kostenGesamtNetto > 0;
              return `
                <button onclick="state.selectedMonth = '${m}'; render();" class="px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap ${state.selectedMonth === m ? 'bg-emerald-600 text-white' : hasData ? 'bg-slate-800 text-slate-300 hover:bg-slate-700' : 'bg-slate-900 text-slate-500 hover:bg-slate-800'}">
                  ${m.slice(0, 3)}
                  ${hasData && state.selectedMonth !== m ? `<span class="ml-1 w-1.5 h-1.5 bg-emerald-500 rounded-full inline-block"></span>` : ''}
                </button>
              `;
            }).join('')}
          </div>
          
          <!-- Tabs & Buttons -->
          <div class="flex gap-2 mb-6 flex-wrap">
            <button onclick="state.activeTab = 'eingabe'; render();" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${state.activeTab === 'eingabe' ? 'bg-slate-800 text-white' : 'text-slate-400 hover:text-white hover:bg-slate-800/50'}">
              üìù Dateneingabe
            </button>
            <button onclick="state.activeTab = 'uebersicht'; render();" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${state.activeTab === 'uebersicht' ? 'bg-slate-800 text-white' : 'text-slate-400 hover:text-white hover:bg-slate-800/50'}">
              üìä Jahres√ºbersicht
            </button>
            
            <div class="flex-1"></div>
            
            <button onclick="handleCsvImport()" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 hover:bg-blue-500 text-white transition-colors">
              üìä Shopify CSV
            </button>
            <button onclick="handlePdfUpload()" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-emerald-600 hover:bg-emerald-500 text-white transition-colors">
              üìÑ PDF Rechnung
            </button>
            <button onclick="exportBackup()" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-slate-800 text-slate-300 hover:bg-slate-700 transition-colors">
              üíæ Backup
            </button>
            <button onclick="importBackup()" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-slate-800 text-slate-300 hover:bg-slate-700 transition-colors">
              üìÇ Restore
            </button>
          </div>
          
          ${state.activeTab === 'eingabe' ? renderEingabeShop(monthData, calc, costsByCategory) : renderUebersichtShop(yearSummary, yearTotals)}
        </div>
        
        ${state.showPdfModal ? renderPdfModal() : ''}
        ${state.showApiKeyModal ? renderApiKeyModal() : ''}
        ${state.showSettingsModal ? renderSettingsModal() : ''}
        ${state.showPaypalHelpModal ? renderPaypalHelpModal() : ''}
        ${state.showShopifyPaymentsHelpModal ? renderShopifyPaymentsHelpModal() : ''}
        ${state.showExportModal ? renderExportModal() : ''}
      `;
    }
    
    function renderEingabeShop(monthData, calc, costsByCategory) {
      const zahlungsgebuehren = monthData.zahlungsgebuehren || { paypal: 0, shopifyPayments: 0, klarna: 0 };
      
      return `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Linke Spalte -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Produkte -->
            <section class="bg-slate-900 rounded-2xl p-6 border border-slate-800">
              <div class="flex items-center justify-between mb-4 cursor-pointer" onclick="state.productsCollapsed = !state.productsCollapsed; render();">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center">üì¶</div>
                  <h2 class="text-lg font-semibold">Produkte & Umsatz</h2>
                  <span class="text-xs text-slate-500">(${monthData.products.length} Produkte)</span>
                  ${calc.retourenAnzahlGesamt > 0 ? `<span class="text-xs text-red-400">(${calc.retourenAnzahlGesamt} Retouren)</span>` : ''}
                </div>
                <button onclick="event.stopPropagation(); addProduct()" class="flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm bg-blue-600 hover:bg-blue-500 transition-colors">
                  + Produkt
                </button>
              </div>
              
              <!-- Produktliste -->
              <div class="space-y-2">
                <div class="grid grid-cols-12 gap-2 text-xs text-slate-500 px-2">
                  <div class="col-span-3">Produkt</div>
                  <div class="col-span-2 text-right">Anzahl</div>
                  <div class="col-span-2 text-right">Umsatz (brutto)</div>
                  <div class="col-span-2 text-right">EK/St√ºck (netto)</div>
                  <div class="col-span-2 text-right">Wareneinsatz</div>
                  <div class="col-span-1"></div>
                </div>
                
                ${(state.productsCollapsed ? monthData.products.slice(0, 3) : monthData.products).map(p => {
                  const hasRetouren = (p.retourenAnzahl || 0) > 0 || (p.retourenBrutto || 0) > 0;
                  const isExpanded = state.expandedProductId === p.id;
                  const nettoAnzahl = calcProductNettoAnzahl(p);
                  
                  return `
                    <div class="bg-slate-800/50 rounded-lg overflow-hidden">
                      <div class="grid grid-cols-12 gap-2 items-center p-2">
                        <div class="col-span-3 flex items-center gap-1">
                          <button onclick="event.stopPropagation(); toggleProductExpand(${p.id})" class="p-1 text-slate-500 hover:text-white transition-colors text-xs" title="Retouren eintragen">
                            ${isExpanded ? '‚ñº' : '‚ñ∂'}
                          </button>
                          <input type="text" value="${p.name}" onchange="updateProduct(${p.id}, 'name', this.value)" class="flex-1 bg-slate-700 rounded px-2 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500" />
                        </div>
                        <input type="number" value="${p.quantity || ''}" onchange="updateProduct(${p.id}, 'quantity', this.value)" class="col-span-2 bg-slate-700 rounded px-2 py-1.5 text-sm text-right focus:outline-none focus:ring-1 focus:ring-emerald-500" placeholder="0" />
                        <input type="number" value="${p.vkBrutto || ''}" onchange="updateProduct(${p.id}, 'vkBrutto', this.value)" class="col-span-2 bg-slate-700 rounded px-2 py-1.5 text-sm text-right focus:outline-none focus:ring-1 focus:ring-emerald-500" placeholder="0.00" step="0.01" />
                        <input type="number" value="${p.ek || ''}" onchange="updateProduct(${p.id}, 'ek', this.value)" class="col-span-2 bg-slate-700 rounded px-2 py-1.5 text-sm text-right focus:outline-none focus:ring-1 focus:ring-emerald-500" placeholder="0.00" step="0.01" />
                        <div class="col-span-2 text-right text-sm font-medium text-amber-400">${formatCurrency(calcProductWareneinsatz(p))}</div>
                        <button onclick="removeProduct(${p.id})" class="col-span-1 p-1.5 text-slate-500 hover:text-red-400 hover:bg-red-500/10 rounded transition-colors" ${monthData.products.length <= 1 ? 'disabled' : ''}>üóëÔ∏è</button>
                      </div>
                      
                      ${hasRetouren ? `
                        <div class="grid grid-cols-12 gap-2 px-2 pb-2 text-xs text-emerald-400">
                          <div class="col-span-3 pl-6 text-slate-500">‚Ü© Nach Retoure:</div>
                          <div class="col-span-2 text-right">${nettoAnzahl} Stk.</div>
                          <div class="col-span-2 text-right">${formatCurrency(calcProductUmsatzBrutto(p))}</div>
                          <div class="col-span-2"></div>
                          <div class="col-span-2"></div>
                          <div class="col-span-1"></div>
                        </div>
                      ` : ''}
                      
                      ${isExpanded ? `
                        <div class="bg-red-500/10 border-t border-red-500/20 p-3">
                          <div class="flex items-center gap-2 mb-2">
                            <span class="text-red-400 text-sm font-medium">‚Ü©Ô∏è Retouren</span>
                          </div>
                          <div class="grid grid-cols-2 gap-4">
                            <div>
                              <label class="text-xs text-slate-400">Anzahl Retouren</label>
                              <input type="number" value="${p.retourenAnzahl || ''}" onchange="updateProduct(${p.id}, 'retourenAnzahl', this.value)" class="w-full bg-slate-700 rounded px-2 py-1.5 text-sm text-right focus:outline-none focus:ring-1 focus:ring-red-500" placeholder="0" />
                            </div>
                            <div>
                              <label class="text-xs text-slate-400">Retouren-Umsatz (brutto)</label>
                              <input type="number" value="${p.retourenBrutto || ''}" onchange="updateProduct(${p.id}, 'retourenBrutto', this.value)" class="w-full bg-slate-700 rounded px-2 py-1.5 text-sm text-right focus:outline-none focus:ring-1 focus:ring-red-500" placeholder="0.00" step="0.01" />
                            </div>
                          </div>
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('')}
                
                ${state.productsCollapsed && monthData.products.length > 3 ? `
                  <button onclick="state.productsCollapsed = false; render();" class="w-full py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">
                    ‚ñº ${monthData.products.length - 3} weitere Produkte anzeigen
                  </button>
                ` : ''}
                
                ${!state.productsCollapsed && monthData.products.length > 3 ? `
                  <button onclick="state.productsCollapsed = true; render();" class="w-full py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">
                    ‚ñ≤ Weniger anzeigen
                  </button>
                ` : ''}
              </div>
              
              <!-- Zusammenfassung -->
              <div class="mt-4 pt-4 border-t border-slate-700 grid grid-cols-4 gap-4">
                <div>
                  <p class="text-xs text-slate-500">Umsatz (brutto)</p>
                  <p class="text-lg font-semibold">${formatCurrency(calc.umsatzBrutto)}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-500">Umsatz (netto)</p>
                  <p class="text-lg font-semibold">${formatCurrency(calc.umsatzNetto)}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-500">Wareneinsatz</p>
                  <p class="text-lg font-semibold text-amber-400">${formatCurrency(calc.wareneinsatz)}</p>
                </div>
                ${calc.retourenBruttoGesamt > 0 ? `
                  <div>
                    <p class="text-xs text-red-400">Retouren (brutto)</p>
                    <p class="text-lg font-semibold text-red-400">-${formatCurrency(calc.retourenBruttoGesamt)}</p>
                  </div>
                ` : '<div></div>'}
              </div>
            </section>
            
            <!-- Versandeinnahmen -->
            <section class="bg-slate-900 rounded-2xl p-4 border border-slate-800">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <span class="text-xl">üì¨</span>
                  <span class="font-medium text-emerald-400">Versandeinnahmen (vom Kunden)</span>
                </div>
                <input type="number" value="${monthData.versandEinnahmen || ''}" onchange="updateVersandEinnahmen(this.value)" class="w-32 bg-slate-700 rounded px-3 py-2 text-sm text-right focus:outline-none focus:ring-1 focus:ring-emerald-500" placeholder="0.00" step="0.01" />
              </div>
            </section>
            
            <!-- Zahlungsgeb√ºhren (feste Zeilen) -->
            <section class="bg-slate-900 rounded-2xl p-6 border border-slate-800">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded-lg bg-cyan-500/20 flex items-center justify-center">üí≥</div>
                  <h2 class="font-semibold">Zahlungsgeb√ºhren</h2>
                </div>
              </div>
              
              <div class="space-y-3">
                <!-- PayPal -->
                <div class="flex items-center justify-between bg-slate-800/50 rounded-lg p-3">
                  <div class="flex items-center gap-3">
                    <span class="text-lg">üÖøÔ∏è</span>
                    <span class="font-medium">PayPal</span>
                    <button onclick="state.showPaypalHelpModal = true; render();" class="text-xs text-slate-500 hover:text-cyan-400 transition-colors">‚ÑπÔ∏è</button>
                  </div>
                  <div class="flex items-center gap-2">
                    <input type="number" value="${zahlungsgebuehren.paypal || ''}" onchange="updateZahlungsgebuehr('paypal', this.value)" class="w-28 bg-slate-700 rounded px-2 py-1.5 text-sm text-right focus:outline-none focus:ring-1 focus:ring-cyan-500" placeholder="0.00" step="0.01" />
                    <button onclick="handlePaypalCsvImport()" class="px-2 py-1.5 text-xs bg-cyan-600 hover:bg-cyan-500 rounded transition-colors" title="CSV importieren">üì•</button>
                  </div>
                </div>
                
                <!-- Shopify Payments -->
                <div class="flex items-center justify-between bg-slate-800/50 rounded-lg p-3">
                  <div class="flex items-center gap-3">
                    <span class="text-lg">üõçÔ∏è</span>
                    <span class="font-medium">Shopify Payments</span>
                    <button onclick="state.showShopifyPaymentsHelpModal = true; render();" class="text-xs text-slate-500 hover:text-cyan-400 transition-colors">‚ÑπÔ∏è</button>
                  </div>
                  <div class="flex items-center gap-2">
                    <input type="number" value="${zahlungsgebuehren.shopifyPayments || ''}" onchange="updateZahlungsgebuehr('shopifyPayments', this.value)" class="w-28 bg-slate-700 rounded px-2 py-1.5 text-sm text-right focus:outline-none focus:ring-1 focus:ring-cyan-500" placeholder="0.00" step="0.01" />
                    <button onclick="handleShopifyPaymentsPdfImport()" class="px-2 py-1.5 text-xs bg-cyan-600 hover:bg-cyan-500 rounded transition-colors" title="PDF importieren">üì•</button>
                  </div>
                </div>
                
                <!-- Klarna -->
                <div class="flex items-center justify-between bg-slate-800/50 rounded-lg p-3">
                  <div class="flex items-center gap-3">
                    <span class="text-lg">üî∑</span>
                    <span class="font-medium">Klarna</span>
                  </div>
                  <input type="number" value="${zahlungsgebuehren.klarna || ''}" onchange="updateZahlungsgebuehr('klarna', this.value)" class="w-28 bg-slate-700 rounded px-2 py-1.5 text-sm text-right focus:outline-none focus:ring-1 focus:ring-cyan-500" placeholder="0.00" step="0.01" />
                </div>
              </div>
              
              <div class="mt-3 pt-3 border-t border-slate-700 flex justify-between">
                <span class="font-medium">Gesamt</span>
                <span class="font-semibold text-cyan-400">${formatCurrency(calc.zahlungsgebuehrenGesamt)}</span>
              </div>
            </section>
            
            <!-- Andere Kostenbl√∂cke (ohne Zahlungen) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              ${Object.entries(CATEGORIES_SHOP).filter(([key]) => key !== 'zahlungen').map(([key, cat]) => renderCostCategory(key, cat, costsByCategory[key] || [], calc.kostenByKategorieBrutto[key] || 0, calc.kostenByKategorieNetto[key] || 0)).join('')}
            </div>
          </div>
          
          <!-- Rechte Spalte - Ergebnis -->
          <div class="space-y-6">
            ${renderGuVSummaryShop(calc)}
          </div>
        </div>
      `;
    }
    
    function renderCostCategory(key, cat, costs, totalBrutto, totalNetto) {
      const colorClasses = {
        amber: 'bg-amber-500/20 text-amber-400',
        cyan: 'bg-cyan-500/20 text-cyan-400',
        purple: 'bg-purple-500/20 text-purple-400',
        pink: 'bg-pink-500/20 text-pink-400',
        slate: 'bg-slate-500/20 text-slate-400'
      };
      const textColor = {
        amber: 'text-amber-400',
        cyan: 'text-cyan-400',
        purple: 'text-purple-400',
        pink: 'text-pink-400',
        slate: 'text-slate-400'
      };
      
      return `
        <section class="bg-slate-900 rounded-2xl p-6 border border-slate-800">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-lg ${colorClasses[cat.color]} flex items-center justify-center">${cat.icon}</div>
              <h2 class="font-semibold">${cat.name}</h2>
            </div>
            <button onclick="addManualCost('${key}')" class="p-1.5 hover:bg-slate-700 rounded transition-colors text-slate-400 hover:text-white" title="Position hinzuf√ºgen">
              +
            </button>
          </div>
          
          <div class="space-y-2 max-h-64 overflow-y-auto">
            ${costs.length === 0 ? `<p class="text-sm text-slate-600 italic">Keine Positionen ‚Äì klicke + oder lade eine PDF-Rechnung hoch</p>` : ''}
            ${costs.map(c => `
              <div class="flex items-center gap-2 bg-slate-800/50 rounded-lg p-2 group">
                <input type="text" value="${c.name}" onchange="updateCost(${c.id}, 'name', this.value)" class="flex-1 bg-transparent text-sm focus:outline-none focus:bg-slate-700 rounded px-1" placeholder="Name" />
                <input type="number" value="${c.betrag || ''}" onchange="updateCost(${c.id}, 'betrag', this.value)" class="w-24 bg-slate-700 rounded px-2 py-1 text-sm text-right focus:outline-none focus:ring-1 focus:ring-emerald-500" placeholder="Brutto" step="0.01" />
                <button onclick="removeCost(${c.id})" class="p-1 text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">üóëÔ∏è</button>
              </div>
            `).join('')}
          </div>
          
          <div class="mt-3 pt-3 border-t border-slate-700">
            <div class="flex justify-between text-sm mb-1">
              <span class="text-slate-500">Brutto</span>
              <span class="text-slate-400">${formatCurrency(totalBrutto)}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm font-medium">Netto</span>
              <span class="font-semibold ${textColor[cat.color]}">${formatCurrency(totalNetto)}</span>
            </div>
          </div>
        </section>
      `;
    }
    
    function renderGuVSummaryShop(calc) {
      const ruecklage = calc.betriebsergebnis > 0 ? calc.betriebsergebnis * (state.ruecklageShop / 100) : 0;
      const verfuegbar = calc.betriebsergebnis - ruecklage;
      
      return `
        <section class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl p-6 border border-slate-700 sticky top-24">
          <h2 class="text-lg font-semibold mb-4">GuV ${state.selectedMonth} ${state.selectedYear}</h2>
          
          <div class="space-y-4">
            <!-- UMSATZ -->
            <div class="space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-slate-400">Umsatz (brutto)</span>
                <span class="text-slate-500">${formatCurrency(calc.umsatzBrutto)}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-slate-300">Umsatz (netto)</span>
                <span>${formatCurrency(calc.umsatzNetto)}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-slate-400">‚Äì Wareneinsatz (netto)</span>
                <span class="text-red-400">‚Äì${formatCurrency(calc.wareneinsatz)}</span>
              </div>
              <div class="flex justify-between text-sm font-medium pt-2 border-t border-slate-700">
                <span>= Rohertrag</span>
                <span class="${calc.rohertrag >= 0 ? 'text-emerald-400' : 'text-red-400'}">${formatCurrency(calc.rohertrag)}</span>
              </div>
            </div>
            
            <!-- VERSAND & KOSTEN (alles netto) -->
            <div class="space-y-2 pt-2 border-t border-slate-700">
              <div class="flex justify-between text-sm">
                <span class="text-emerald-400">+ Versandeinnahmen (netto)</span>
                <span class="text-emerald-400">+${formatCurrency(calc.versandEinnahmenNetto)}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-slate-400">‚Äì Versand & Logistik (netto)</span>
                <span class="text-red-400">‚Äì${formatCurrency(calc.kostenByKategorieNetto.versand)}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-slate-400">‚Äì Zahlungsgeb√ºhren (netto)</span>
                <span class="text-red-400">‚Äì${formatCurrency(calc.kostenByKategorieNetto.zahlungen)}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-slate-400">‚Äì Tools (netto)</span>
                <span class="text-red-400">‚Äì${formatCurrency(calc.kostenByKategorieNetto.tools)}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-slate-400">‚Äì Marketing (netto)</span>
                <span class="text-red-400">‚Äì${formatCurrency(calc.kostenByKategorieNetto.marketing)}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-slate-400">‚Äì Sonstige (netto)</span>
                <span class="text-red-400">‚Äì${formatCurrency(calc.kostenByKategorieNetto.sonstige)}</span>
              </div>
            </div>
            
            <!-- BETRIEBSERGEBNIS -->
            <div class="p-4 rounded-xl ${calc.betriebsergebnis >= 0 ? 'bg-emerald-500/20' : 'bg-red-500/20'}">
              <div class="flex justify-between items-center">
                <span class="font-semibold">BETRIEBSERGEBNIS</span>
                <span class="text-2xl font-bold ${calc.betriebsergebnis >= 0 ? 'text-emerald-400' : 'text-red-400'}">${formatCurrency(calc.betriebsergebnis)}</span>
              </div>
              <div class="flex justify-between items-center mt-2 text-sm">
                <span class="text-slate-400">Gewinnmarge</span>
                <span class="${calc.gewinnmarge >= 0 ? 'text-emerald-400' : 'text-red-400'}">${formatPercent(calc.gewinnmarge)}</span>
              </div>
            </div>
            
            <!-- R√úCKLAGE -->
            <div class="pt-4 border-t border-slate-700">
              <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-medium">R√ºcklage (Steuern etc.)</span>
                <div class="flex items-center gap-2">
                  <input type="number" value="${state.ruecklageShop}" onchange="state.ruecklageShop = parseInt(this.value) || 0; saveData();" class="w-16 bg-slate-700 rounded px-2 py-1 text-sm text-right focus:outline-none focus:ring-1 focus:ring-emerald-500" min="0" max="100" />
                  <span class="text-sm text-slate-400">%</span>
                </div>
              </div>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-amber-400">‚Üí R√ºcklage</span>
                  <span class="text-amber-400">${formatCurrency(ruecklage)}</span>
                </div>
                <div class="flex justify-between font-medium">
                  <span class="text-emerald-300">‚Üí Verf√ºgbar</span>
                  <span class="text-emerald-300">${formatCurrency(verfuegbar)}</span>
                </div>
              </div>
            </div>
            
            <!-- MwSt. INFO (separat - nur zur Info) -->
            <div class="pt-4 border-t border-slate-700">
              <p class="text-xs text-slate-500 mb-2">MwSt.-√úbersicht (Liquidit√§t)</p>
              <div class="space-y-1 text-xs">
                <div class="flex justify-between">
                  <span class="text-slate-500">Umsatzsteuer</span>
                  <span class="text-slate-400">${formatCurrency(calc.umsatzsteuer)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-500">‚Äì Vorsteuer</span>
                  <span class="text-emerald-400">‚Äì${formatCurrency(calc.vorsteuer)}</span>
                </div>
                <div class="flex justify-between font-medium">
                  <span class="text-slate-400">= MwSt.-Zahllast</span>
                  <span class="${calc.mwstZahllast >= 0 ? 'text-red-400' : 'text-emerald-400'}">${formatCurrency(calc.mwstZahllast)}</span>
                </div>
              </div>
            </div>
          </div>
        </section>
      `;
    }
    
    function renderUebersichtShop(yearSummary, yearTotals) {
      // Produkt-Ranking berechnen
      const productStats = {};
      const yearData = state.years[state.selectedYear] || {};
      
      MONTHS.forEach(month => {
        const monthData = yearData[month];
        if (!monthData?.products) return;
        
        monthData.products.forEach(p => {
          if (!p.name || p.name.startsWith('Produkt ')) return;
          
          const nettoUmsatz = calcProductUmsatzNetto(p);
          const wareneinsatz = calcProductWareneinsatz(p);
          const nettoAnzahl = calcProductNettoAnzahl(p);
          
          if (!productStats[p.name]) {
            productStats[p.name] = { name: p.name, umsatz: 0, wareneinsatz: 0, anzahl: 0, rohertrag: 0 };
          }
          productStats[p.name].umsatz += nettoUmsatz;
          productStats[p.name].wareneinsatz += wareneinsatz;
          productStats[p.name].anzahl += nettoAnzahl;
          productStats[p.name].rohertrag += (nettoUmsatz - wareneinsatz);
        });
      });
      
      const topProducts = Object.values(productStats)
        .filter(p => p.umsatz > 0)
        .map(p => ({ ...p, marge: p.umsatz > 0 ? p.rohertrag / p.umsatz : 0 }))
        .sort((a, b) => b.rohertrag - a.rohertrag)
        .slice(0, 10);
      
      // Vorjahresvergleich
      const prevYear = state.selectedYear - 1;
      const prevYearData = state.years[prevYear];
      let prevYearTotals = null;
      
      if (prevYearData) {
        prevYearTotals = { umsatzBrutto: 0, umsatzNetto: 0, kostenGesamtNetto: 0, betriebsergebnis: 0 };
        MONTHS.forEach(month => {
          const calc = calcMonthData(prevYearData[month] || createDefaultMonthData());
          prevYearTotals.umsatzBrutto += calc.umsatzBrutto;
          prevYearTotals.umsatzNetto += calc.umsatzNetto;
          prevYearTotals.kostenGesamtNetto += calc.kostenGesamtNetto;
          prevYearTotals.betriebsergebnis += calc.betriebsergebnis;
        });
      }
      
      const deltaUmsatz = prevYearTotals ? ((yearTotals.umsatzNetto - prevYearTotals.umsatzNetto) / prevYearTotals.umsatzNetto) : null;
      const deltaGewinn = prevYearTotals ? ((yearTotals.betriebsergebnis - prevYearTotals.betriebsergebnis) / Math.abs(prevYearTotals.betriebsergebnis || 1)) : null;
      
      // R√ºcklage berechnen
      const jahresRuecklage = yearTotals.betriebsergebnis > 0 ? yearTotals.betriebsergebnis * (state.ruecklageShop / 100) : 0;
      const jahresVerfuegbar = yearTotals.betriebsergebnis - jahresRuecklage;
      
      return `
        <div class="space-y-6">
          <!-- Header mit Export -->
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Jahres√ºbersicht ${state.selectedYear}</h2>
            <button onclick="state.showExportModal = true; render();" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 transition-colors text-sm font-medium">
              üì§ Exportieren
            </button>
          </div>
          
          <!-- KPI Cards -->
          <section class="bg-slate-900 rounded-2xl p-6 border border-slate-800">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
              <div class="bg-slate-800 rounded-xl p-4">
                <p class="text-xs text-slate-500 mb-1">Jahresumsatz (netto)</p>
                <p class="text-xl font-bold">${formatCurrency(yearTotals.umsatzNetto)}</p>
                ${deltaUmsatz !== null ? `
                  <p class="text-xs mt-1 ${deltaUmsatz >= 0 ? 'text-emerald-400' : 'text-red-400'}">
                    ${deltaUmsatz >= 0 ? '‚Üë' : '‚Üì'} ${formatPercent(Math.abs(deltaUmsatz))} vs. ${prevYear}
                  </p>
                ` : ''}
              </div>
              <div class="bg-slate-800 rounded-xl p-4">
                <p class="text-xs text-slate-500 mb-1">Kosten (netto)</p>
                <p class="text-xl font-bold text-red-400">${formatCurrency(yearTotals.kostenGesamtNetto)}</p>
              </div>
              <div class="rounded-xl p-4 ${yearTotals.betriebsergebnis >= 0 ? 'bg-emerald-500/20' : 'bg-red-500/20'}">
                <p class="text-xs text-slate-400 mb-1">Betriebsergebnis</p>
                <p class="text-xl font-bold ${yearTotals.betriebsergebnis >= 0 ? 'text-emerald-400' : 'text-red-400'}">${formatCurrency(yearTotals.betriebsergebnis)}</p>
                ${deltaGewinn !== null ? `
                  <p class="text-xs mt-1 ${deltaGewinn >= 0 ? 'text-emerald-400' : 'text-red-400'}">
                    ${deltaGewinn >= 0 ? '‚Üë' : '‚Üì'} ${formatPercent(Math.abs(deltaGewinn))} vs. ${prevYear}
                  </p>
                ` : ''}
              </div>
              <div class="bg-amber-500/20 rounded-xl p-4">
                <p class="text-xs text-amber-400 mb-1">R√ºcklage (${state.ruecklageShop}%)</p>
                <p class="text-xl font-bold text-amber-400">${formatCurrency(jahresRuecklage)}</p>
              </div>
              <div class="bg-emerald-500/10 rounded-xl p-4">
                <p class="text-xs text-emerald-300 mb-1">Verf√ºgbar</p>
                <p class="text-xl font-bold text-emerald-300">${formatCurrency(jahresVerfuegbar)}</p>
              </div>
            </div>
          </section>
          
          <!-- Chart (ASCII-basiert) -->
          <section class="bg-slate-900 rounded-2xl p-6 border border-slate-800">
            <h3 class="text-sm font-medium text-slate-400 mb-4">üìä Monatlicher Verlauf</h3>
            <div class="h-40 flex items-end justify-between gap-1">
              ${yearSummary.map(m => {
                const maxUmsatz = Math.max(...yearSummary.map(x => x.umsatzNetto), 1);
                const heightPercent = (m.umsatzNetto / maxUmsatz) * 100;
                const gewinnPercent = m.umsatzNetto > 0 ? ((m.betriebsergebnis / m.umsatzNetto) * 100) : 0;
                
                return `
                  <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-full flex flex-col justify-end h-32">
                      <div class="w-full rounded-t ${m.betriebsergebnis >= 0 ? 'bg-emerald-500/60' : 'bg-red-500/60'}" style="height: ${Math.max(heightPercent, 2)}%;" title="${m.month}: ${formatCurrency(m.umsatzNetto)}"></div>
                    </div>
                    <span class="text-xs text-slate-500">${m.month.slice(0, 3)}</span>
                  </div>
                `;
              }).join('')}
            </div>
          </section>
          
          <!-- Monatstabelle -->
          <section class="bg-slate-900 rounded-2xl p-6 border border-slate-800">
            <h3 class="text-sm font-medium text-slate-400 mb-4">üìÖ Monats√ºbersicht</h3>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="text-slate-500 border-b border-slate-700">
                    <th class="text-left py-3 px-2">Monat</th>
                    <th class="text-right py-3 px-2">Umsatz (brutto)</th>
                    <th class="text-right py-3 px-2">Umsatz (netto)</th>
                    <th class="text-right py-3 px-2">Kosten (netto)</th>
                    <th class="text-right py-3 px-2">Betriebsergebnis</th>
                    <th class="text-right py-3 px-2">Marge</th>
                  </tr>
                </thead>
                <tbody>
                  ${yearSummary.map(m => `
                    <tr class="border-b border-slate-800 hover:bg-slate-800/50 cursor-pointer transition-colors ${m.umsatzBrutto === 0 && m.kostenGesamtNetto === 0 ? 'text-slate-600' : ''}" onclick="state.selectedMonth = '${m.month}'; state.activeTab = 'eingabe'; render();">
                      <td class="py-3 px-2 font-medium">${m.month}</td>
                      <td class="text-right py-3 px-2">${formatCurrency(m.umsatzBrutto)}</td>
                      <td class="text-right py-3 px-2">${formatCurrency(m.umsatzNetto)}</td>
                      <td class="text-right py-3 px-2 text-red-400">${formatCurrency(m.kostenGesamtNetto)}</td>
                      <td class="text-right py-3 px-2 font-medium ${m.betriebsergebnis >= 0 ? 'text-emerald-400' : 'text-red-400'}">${formatCurrency(m.betriebsergebnis)}</td>
                      <td class="text-right py-3 px-2 ${m.gewinnmarge >= 0 ? 'text-emerald-400' : 'text-red-400'}">${formatPercent(m.gewinnmarge)}</td>
                    </tr>
                  `).join('')}
                </tbody>
                <tfoot>
                  <tr class="font-semibold bg-slate-800">
                    <td class="py-3 px-2">GESAMT</td>
                    <td class="text-right py-3 px-2">${formatCurrency(yearTotals.umsatzBrutto)}</td>
                    <td class="text-right py-3 px-2">${formatCurrency(yearTotals.umsatzNetto)}</td>
                    <td class="text-right py-3 px-2 text-red-400">${formatCurrency(yearTotals.kostenGesamtNetto)}</td>
                    <td class="text-right py-3 px-2 ${yearTotals.betriebsergebnis >= 0 ? 'text-emerald-400' : 'text-red-400'}">${formatCurrency(yearTotals.betriebsergebnis)}</td>
                    <td class="text-right py-3 px-2">‚Äì</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </section>
          
          <!-- Produkt-Ranking -->
          ${topProducts.length > 0 ? `
            <section class="bg-slate-900 rounded-2xl p-6 border border-slate-800">
              <h3 class="text-sm font-medium text-slate-400 mb-4">üèÜ Top Produkte nach Rohertrag</h3>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="text-slate-500 border-b border-slate-700">
                      <th class="text-left py-2 px-2">#</th>
                      <th class="text-left py-2 px-2">Produkt</th>
                      <th class="text-right py-2 px-2">Anzahl</th>
                      <th class="text-right py-2 px-2">Umsatz (netto)</th>
                      <th class="text-right py-2 px-2">Wareneinsatz</th>
                      <th class="text-right py-2 px-2">Rohertrag</th>
                      <th class="text-right py-2 px-2">Marge</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${topProducts.map((p, i) => `
                      <tr class="border-b border-slate-800">
                        <td class="py-2 px-2 font-medium ${i < 3 ? 'text-amber-400' : 'text-slate-500'}">${i + 1}</td>
                        <td class="py-2 px-2">${p.name}</td>
                        <td class="text-right py-2 px-2">${p.anzahl}</td>
                        <td class="text-right py-2 px-2">${formatCurrency(p.umsatz)}</td>
                        <td class="text-right py-2 px-2 text-red-400">${formatCurrency(p.wareneinsatz)}</td>
                        <td class="text-right py-2 px-2 font-medium ${p.rohertrag >= 0 ? 'text-emerald-400' : 'text-red-400'}">${formatCurrency(p.rohertrag)}</td>
                        <td class="text-right py-2 px-2 ${p.marge >= 0 ? 'text-emerald-400' : 'text-red-400'}">${formatPercent(p.marge)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </section>
          ` : ''}
        </div>
      `;
    }
    
    
    function renderPdfModal() {
      // Verf√ºgbare Kategorien
      const availableCategories = CATEGORIES_SHOP;
      
      return `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 no-drag">
          <div class="bg-slate-900 rounded-2xl p-6 max-w-md w-full border border-slate-700 fade-in">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">üìÑ PDF Rechnung analysieren</h3>
              <button onclick="state.showPdfModal = false; state.pdfResult = null; render();" class="p-1 hover:bg-slate-800 rounded">‚úï</button>
            </div>
            
            <p class="text-xs text-slate-500 mb-4">Wird hinzugef√ºgt zu: <span class="text-emerald-400 font-medium">üõí Online Shop</span> ‚Üí ${state.selectedMonth}</p>
            
            ${state.pdfProcessing ? `
              <div class="text-center py-8">
                <div class="w-10 h-10 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-sm text-slate-400">Rechnung wird analysiert...</p>
              </div>
            ` : state.pdfResult && !state.pdfResult.error ? `
              <div class="space-y-4">
                ${state.pdfResult.waehrung && state.pdfResult.waehrung !== 'EUR' && state.pdfResult.exchangeRate ? `
                  <div class="bg-blue-500/20 border border-blue-500/30 rounded-xl p-3">
                    <div class="flex items-center gap-2 text-blue-400 text-sm mb-2">
                      <span>üí±</span>
                      <span class="font-medium">Fremdw√§hrung erkannt</span>
                    </div>
                    <div class="text-xs text-slate-400 space-y-1">
                      <div class="flex justify-between">
                        <span>Original (${state.pdfResult.waehrung})</span>
                        <span>${state.pdfResult.bruttoOriginal?.toFixed(2)} ${state.pdfResult.waehrung}</span>
                      </div>
                      <div class="flex justify-between">
                        <span>Wechselkurs</span>
                        <span>1 ${state.pdfResult.waehrung} = ${state.pdfResult.exchangeRate?.toFixed(4)} EUR</span>
                      </div>
                      <div class="flex justify-between font-medium text-blue-300">
                        <span>Umgerechnet (EUR)</span>
                        <span>${formatCurrency(state.pdfResult.brutto)}</span>
                      </div>
                    </div>
                  </div>
                ` : ''}
                
                <div class="bg-slate-800 rounded-xl p-4 space-y-3">
                  <div class="flex justify-between items-center">
                    <span class="text-slate-400">Lieferant</span>
                    <span class="font-medium">${state.pdfResult.lieferant}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-slate-400">Kategorie</span>
                    <select onchange="changePdfKategorie(this.value)" class="bg-slate-700 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500">
                      ${Object.entries(availableCategories).map(([key, cat]) => `
                        <option value="${key}" ${state.pdfResult.kategorie === key ? 'selected' : ''}>${cat.icon} ${cat.name}</option>
                      `).join('')}
                    </select>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-slate-400">Datum</span>
                    <span>${state.pdfResult.datum}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-slate-400">Brutto (EUR)</span>
                    <span class="font-medium">${formatCurrency(state.pdfResult.brutto)}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-slate-400">MwSt.</span>
                    <span>${formatCurrency(state.pdfResult.mwst)}</span>
                  </div>
                  ${state.pdfResult.beschreibung ? `
                    <div class="pt-2 border-t border-slate-700">
                      <span class="text-slate-400 text-sm">${state.pdfResult.beschreibung}</span>
                    </div>
                  ` : ''}
                </div>
                
                <div class="flex gap-3">
                  <button onclick="state.pdfResult = null; handlePdfUpload();" class="flex-1 py-2 px-4 rounded-lg bg-slate-800 hover:bg-slate-700 transition-colors">
                    Andere Datei
                  </button>
                  <button onclick="applyPdfResult()" class="flex-1 py-2 px-4 rounded-lg bg-emerald-600 hover:bg-emerald-500 transition-colors font-medium">
                    √úbernehmen
                  </button>
                </div>
              </div>
            ` : state.pdfResult?.error ? `
              <div class="bg-red-500/20 rounded-xl p-4 text-center">
                <p class="text-4xl mb-2">‚ö†Ô∏è</p>
                <p class="text-sm text-red-400">${state.pdfResult.error}</p>
                <button onclick="state.pdfResult = null; render();" class="mt-4 py-2 px-4 rounded-lg bg-slate-800 hover:bg-slate-700 transition-colors">
                  Erneut versuchen
                </button>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    function renderApiKeyModal() {
      return `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 no-drag">
          <div class="bg-slate-900 rounded-2xl p-6 max-w-md w-full border border-slate-700 fade-in">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">üîë API Key erforderlich</h3>
              <button onclick="state.showApiKeyModal = false; render();" class="p-1 hover:bg-slate-800 rounded">‚úï</button>
            </div>
            
            <p class="text-sm text-slate-400 mb-4">
              Um PDF-Rechnungen zu analysieren, ben√∂tigst du einen Anthropic API Key. 
              Du bekommst ihn unter <a href="https://console.anthropic.com" target="_blank" class="text-emerald-400 hover:underline">console.anthropic.com</a>
            </p>
            
            <input type="password" id="apiKeyInput" value="${state.apiKey}" placeholder="sk-ant-..." class="w-full bg-slate-800 rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500 mb-4" />
            
            <button onclick="state.apiKey = document.getElementById('apiKeyInput').value; state.showApiKeyModal = false; saveData(); handlePdfUpload();" class="w-full py-2 px-4 rounded-lg bg-emerald-600 hover:bg-emerald-500 transition-colors font-medium">
              Speichern & fortfahren
            </button>
          </div>
        </div>
      `;
    }
    
    function renderPaypalHelpModal() {
      return `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 no-drag">
          <div class="bg-slate-900 rounded-2xl p-6 max-w-md w-full border border-slate-700 fade-in">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">üÖøÔ∏è PayPal Geb√ºhren exportieren</h3>
              <button onclick="state.showPaypalHelpModal = false; render();" class="p-1 hover:bg-slate-800 rounded">‚úï</button>
            </div>
            
            <div class="space-y-4 text-sm text-slate-300">
              <p class="text-slate-400">So exportierst du deine PayPal Geb√ºhren:</p>
              
              <ol class="list-decimal list-inside space-y-2">
                <li>Logge dich in dein <strong class="text-white">PayPal-Konto</strong> ein</li>
                <li>Gehe zu <strong class="text-white">Aktivit√§ten ‚Üí Alle Berichte</strong></li>
                <li>W√§hle Aktionstyp: <strong class="text-white">Alle Transaktionen</strong></li>
                <li>W√§hle den entsprechenden <strong class="text-white">Monat</strong> aus</li>
                <li>W√§hle Format: <strong class="text-white">CSV</strong></li>
                <li>Klicke auf <strong class="text-white">Bericht erstellen</strong></li>
              </ol>
              
              <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-3 mt-4">
                <p class="text-cyan-400 text-xs">üí° Die Geb√ºhren werden aus der Spalte "Fee" / "Geb√ºhren" summiert.</p>
              </div>
            </div>
            
            <button onclick="state.showPaypalHelpModal = false; render();" class="w-full mt-6 py-2 px-4 rounded-lg bg-slate-800 hover:bg-slate-700 transition-colors">
              Verstanden
            </button>
          </div>
        </div>
      `;
    }
    
    function renderShopifyPaymentsHelpModal() {
      return `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 no-drag">
          <div class="bg-slate-900 rounded-2xl p-6 max-w-md w-full border border-slate-700 fade-in">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">üõçÔ∏è Shopify Payments Geb√ºhren exportieren</h3>
              <button onclick="state.showShopifyPaymentsHelpModal = false; render();" class="p-1 hover:bg-slate-800 rounded">‚úï</button>
            </div>
            
            <div class="space-y-4 text-sm text-slate-300">
              <p class="text-slate-400">So exportierst du deine Shopify Payments Geb√ºhren:</p>
              
              <ol class="list-decimal list-inside space-y-2">
                <li>Logge dich in deinen <strong class="text-white">Shopify Shop</strong> ein</li>
                <li>Gehe links im Men√º zu <strong class="text-white">Finanzen ‚Üí Auszahlungen anzeigen</strong></li>
                <li>Klicke oben rechts auf <strong class="text-white">Dokumente</strong></li>
                <li>Lade f√ºr den jeweiligen Monat die <strong class="text-white">PDF</strong> herunter</li>
              </ol>
              
              <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-3 mt-4">
                <p class="text-cyan-400 text-xs">üí° Die "Transaction Fees" werden automatisch aus der PDF extrahiert.</p>
              </div>
            </div>
            
            <button onclick="state.showShopifyPaymentsHelpModal = false; render();" class="w-full mt-6 py-2 px-4 rounded-lg bg-slate-800 hover:bg-slate-700 transition-colors">
              Verstanden
            </button>
          </div>
        </div>
      `;
    }
    
    function renderExportModal() {
      return `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 no-drag">
          <div class="bg-slate-900 rounded-2xl p-6 max-w-md w-full border border-slate-700 fade-in">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">üì§ Daten exportieren</h3>
              <button onclick="state.showExportModal = false; render();" class="p-1 hover:bg-slate-800 rounded">‚úï</button>
            </div>
            
            <div class="space-y-3">
              <button onclick="exportAsExcel(); state.showExportModal = false; render();" class="w-full flex items-center gap-3 p-4 bg-slate-800 hover:bg-slate-700 rounded-xl transition-colors">
                <span class="text-2xl">üìä</span>
                <div class="text-left">
                  <p class="font-medium">Excel Export</p>
                  <p class="text-xs text-slate-400">Jahres√ºbersicht als .xlsx Datei</p>
                </div>
              </button>
              
              <button onclick="exportAsCsv(); state.showExportModal = false; render();" class="w-full flex items-center gap-3 p-4 bg-slate-800 hover:bg-slate-700 rounded-xl transition-colors">
                <span class="text-2xl">üìÑ</span>
                <div class="text-left">
                  <p class="font-medium">CSV Export</p>
                  <p class="text-xs text-slate-400">Monatsdaten als .csv Datei</p>
                </div>
              </button>
              
              <button onclick="exportBackup(); state.showExportModal = false; render();" class="w-full flex items-center gap-3 p-4 bg-slate-800 hover:bg-slate-700 rounded-xl transition-colors">
                <span class="text-2xl">üíæ</span>
                <div class="text-left">
                  <p class="font-medium">Backup (JSON)</p>
                  <p class="text-xs text-slate-400">Alle Daten zur Sicherung</p>
                </div>
              </button>
            </div>
          </div>
        </div>
      `;
    }
    
    // ===== EXPORT FUNKTIONEN =====
    async function exportAsExcel() {
      const yearData = state.years[state.selectedYear] || {};
      
      // CSV-Format erstellen (wird als .csv gespeichert, kann in Excel ge√∂ffnet werden)
      let csv = 'Monat;Umsatz (brutto);Umsatz (netto);Wareneinsatz;Rohertrag;Versand (netto);Kosten Versand;Kosten Zahlungen;Kosten Tools;Kosten Marketing;Kosten Sonstige;Kosten Gesamt;Betriebsergebnis;Marge\n';
      
      let totals = { umsatzBrutto: 0, umsatzNetto: 0, wareneinsatz: 0, rohertrag: 0, versandNetto: 0, kosten: { versand: 0, zahlungen: 0, tools: 0, marketing: 0, sonstige: 0 }, kostenGesamt: 0, betriebsergebnis: 0 };
      
      MONTHS.forEach(month => {
        const monthData = yearData[month] || createDefaultMonthData();
        const calc = calcMonthData(monthData);
        
        csv += `${month};${calc.umsatzBrutto.toFixed(2).replace('.', ',')};${calc.umsatzNetto.toFixed(2).replace('.', ',')};${calc.wareneinsatz.toFixed(2).replace('.', ',')};${calc.rohertrag.toFixed(2).replace('.', ',')};${calc.versandEinnahmenNetto.toFixed(2).replace('.', ',')};${calc.kostenByKategorieNetto.versand.toFixed(2).replace('.', ',')};${calc.kostenByKategorieNetto.zahlungen.toFixed(2).replace('.', ',')};${calc.kostenByKategorieNetto.tools.toFixed(2).replace('.', ',')};${calc.kostenByKategorieNetto.marketing.toFixed(2).replace('.', ',')};${calc.kostenByKategorieNetto.sonstige.toFixed(2).replace('.', ',')};${calc.kostenGesamtNetto.toFixed(2).replace('.', ',')};${calc.betriebsergebnis.toFixed(2).replace('.', ',')};${(calc.gewinnmarge * 100).toFixed(1).replace('.', ',')}%\n`;
        
        totals.umsatzBrutto += calc.umsatzBrutto;
        totals.umsatzNetto += calc.umsatzNetto;
        totals.wareneinsatz += calc.wareneinsatz;
        totals.rohertrag += calc.rohertrag;
        totals.versandNetto += calc.versandEinnahmenNetto;
        totals.kosten.versand += calc.kostenByKategorieNetto.versand;
        totals.kosten.zahlungen += calc.kostenByKategorieNetto.zahlungen;
        totals.kosten.tools += calc.kostenByKategorieNetto.tools;
        totals.kosten.marketing += calc.kostenByKategorieNetto.marketing;
        totals.kosten.sonstige += calc.kostenByKategorieNetto.sonstige;
        totals.kostenGesamt += calc.kostenGesamtNetto;
        totals.betriebsergebnis += calc.betriebsergebnis;
      });
      
      csv += `GESAMT;${totals.umsatzBrutto.toFixed(2).replace('.', ',')};${totals.umsatzNetto.toFixed(2).replace('.', ',')};${totals.wareneinsatz.toFixed(2).replace('.', ',')};${totals.rohertrag.toFixed(2).replace('.', ',')};${totals.versandNetto.toFixed(2).replace('.', ',')};${totals.kosten.versand.toFixed(2).replace('.', ',')};${totals.kosten.zahlungen.toFixed(2).replace('.', ',')};${totals.kosten.tools.toFixed(2).replace('.', ',')};${totals.kosten.marketing.toFixed(2).replace('.', ',')};${totals.kosten.sonstige.toFixed(2).replace('.', ',')};;${totals.betriebsergebnis.toFixed(2).replace('.', ',')};\n`;
      
      await ipcRenderer.invoke('save-export', {
        content: csv,
        filename: `GuV_${state.selectedYear}_Shop.csv`,
        type: 'csv'
      });
    }
    
    async function exportAsCsv() {
      const monthData = state.years[state.selectedYear]?.[state.selectedMonth] || createDefaultMonthData();
      
      // Produkte exportieren
      let csv = 'Produkt;Anzahl;Umsatz (brutto);EK/St√ºck;Wareneinsatz;Retouren Anzahl;Retouren Umsatz\n';
      
      monthData.products.forEach(p => {
        csv += `${p.name};${p.quantity || 0};${(p.vkBrutto || 0).toFixed(2).replace('.', ',')};${(p.ek || 0).toFixed(2).replace('.', ',')};${calcProductWareneinsatz(p).toFixed(2).replace('.', ',')};${p.retourenAnzahl || 0};${(p.retourenBrutto || 0).toFixed(2).replace('.', ',')}\n`;
      });
      
      await ipcRenderer.invoke('save-export', {
        content: csv,
        filename: `Produkte_${state.selectedMonth}_${state.selectedYear}.csv`,
        type: 'csv'
      });
    }
    
    async function exportBackup() {
      const backup = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        yearsShop: state.years,
        ekPresets: state.ekPresets,
        ruecklageShop: state.ruecklageShop
      };
      
      await ipcRenderer.invoke('save-export', {
        content: JSON.stringify(backup, null, 2),
        filename: `GuV_Backup_${new Date().toISOString().split('T')[0]}.json`,
        type: 'json'
      });
    }
    
    async function importBackup() {
      const result = await ipcRenderer.invoke('import-backup');
      if (!result) return;
      
      try {
        const backup = JSON.parse(result);
        
        if (backup.yearsShop) state.years = backup.yearsShop;
        if (backup.ekPresets) state.ekPresets = backup.ekPresets;
        if (backup.ruecklageShop !== undefined) state.ruecklageShop = backup.ruecklageShop;
        
        saveData();
        alert('Backup erfolgreich importiert!');
      } catch (err) {
        alert('Fehler beim Importieren: ' + err.message);
      }
    }
    
    function renderSettingsModal() {
      return `
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 no-drag">
          <div class="bg-slate-900 rounded-2xl p-6 max-w-lg w-full border border-slate-700 fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">‚öôÔ∏è Einstellungen</h3>
              <button onclick="state.showSettingsModal = false; render();" class="p-1 hover:bg-slate-800 rounded">‚úï</button>
            </div>
            
            <div class="space-y-6">
              <!-- API Key -->
              <div>
                <label class="block text-sm text-slate-400 mb-2">Anthropic API Key</label>
                <input type="password" id="settingsApiKey" value="${state.apiKey}" placeholder="sk-ant-..." class="w-full bg-slate-800 rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500" />
                <p class="text-xs text-slate-600 mt-1">F√ºr PDF-Analyse. Hol dir einen Key unter <a href="https://console.anthropic.com" target="_blank" class="text-emerald-400 hover:underline">console.anthropic.com</a></p>
              </div>
              
              <!-- EK Presets -->
              <div>
                <div class="flex justify-between items-center mb-2">
                  <label class="block text-sm text-slate-400">Standard-EK pro Variante</label>
                  <button onclick="addEkPreset()" class="text-xs px-2 py-1 bg-blue-600 hover:bg-blue-500 rounded transition-colors">+ Hinzuf√ºgen</button>
                </div>
                <p class="text-xs text-slate-600 mb-3">Diese EK-Werte werden automatisch beim CSV-Import zugewiesen, wenn die Variante den Namen enth√§lt.</p>
                
                <div class="space-y-2 max-h-48 overflow-y-auto">
                  ${Object.entries(state.ekPresets).map(([key, value]) => `
                    <div class="flex items-center gap-2 bg-slate-800 rounded-lg p-2">
                      <span class="flex-1 text-sm">${key}</span>
                      <input type="number" value="${value}" onchange="updateEkPreset('${key}', this.value)" class="w-24 bg-slate-700 rounded px-2 py-1 text-sm text-right focus:outline-none focus:ring-1 focus:ring-emerald-500" step="0.01" />
                      <span class="text-xs text-slate-500">‚Ç¨</span>
                      <button onclick="removeEkPreset('${key}')" class="p-1 text-slate-500 hover:text-red-400 transition-colors">üóëÔ∏è</button>
                    </div>
                  `).join('')}
                </div>
              </div>
              
              <button onclick="state.apiKey = document.getElementById('settingsApiKey').value; state.showSettingsModal = false; saveData();" class="w-full py-2 px-4 rounded-lg bg-emerald-600 hover:bg-emerald-500 transition-colors font-medium">
                Speichern
              </button>
            </div>
          </div>
        </div>
      `;
    }
    
    
    // ===== START =====
    loadData();
  </script>
</body>
</html>
